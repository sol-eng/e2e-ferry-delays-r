<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.555">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Raw Data Download</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="01-raw-data-write_files/libs/clipboard/clipboard.min.js"></script>
<script src="01-raw-data-write_files/libs/quarto-html/quarto.js"></script>
<script src="01-raw-data-write_files/libs/quarto-html/popper.min.js"></script>
<script src="01-raw-data-write_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="01-raw-data-write_files/libs/quarto-html/anchor.min.js"></script>
<link href="01-raw-data-write_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="01-raw-data-write_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="01-raw-data-write_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="01-raw-data-write_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="01-raw-data-write_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
</head>
<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#goals" id="toc-goals" class="nav-link active" data-scroll-target="#goals">Goals</a></li>
  <li>
<a href="#data-sources" id="toc-data-sources" class="nav-link" data-scroll-target="#data-sources">Data sources</a>
  <ul class="collapse">
<li><a href="#from-wsdot-traveler-information-api" id="toc-from-wsdot-traveler-information-api" class="nav-link" data-scroll-target="#from-wsdot-traveler-information-api">From WSDOT Traveler Information API</a></li>
  <li><a href="#from-open-meteo" id="toc-from-open-meteo" class="nav-link" data-scroll-target="#from-open-meteo">From Open Meteo</a></li>
  </ul>
</li>
  <li><a href="#task-1---get-and-set-wsdot-environment-variable" id="toc-task-1---get-and-set-wsdot-environment-variable" class="nav-link" data-scroll-target="#task-1---get-and-set-wsdot-environment-variable">Task 1 - Get and set WSDOT environment variable</a></li>
  <li><a href="#load-packages" id="toc-load-packages" class="nav-link" data-scroll-target="#load-packages">Load Packages</a></li>
  <li><a href="#task-2---download-vessel-verbose-data" id="toc-task-2---download-vessel-verbose-data" class="nav-link" data-scroll-target="#task-2---download-vessel-verbose-data">Task 2 - Download vessel verbose data</a></li>
  <li><a href="#task-3---connect-to-the-database" id="toc-task-3---connect-to-the-database" class="nav-link" data-scroll-target="#task-3---connect-to-the-database">Task 3 - Connect to the database</a></li>
  <li><a href="#task-4---write-to-the-database" id="toc-task-4---write-to-the-database" class="nav-link" data-scroll-target="#task-4---write-to-the-database">Task 4 - Write to the database</a></li>
  <li>
<a href="#task-5---get-and-write-the-other-data-sets" id="toc-task-5---get-and-write-the-other-data-sets" class="nav-link" data-scroll-target="#task-5---get-and-write-the-other-data-sets">Task 5 - Get and write the other data sets</a>
  <ul class="collapse">
<li><a href="#vessel-history" id="toc-vessel-history" class="nav-link" data-scroll-target="#vessel-history">Vessel history</a></li>
  <li><a href="#terminal-locations" id="toc-terminal-locations" class="nav-link" data-scroll-target="#terminal-locations">Terminal locations</a></li>
  <li><a href="#weather-data" id="toc-weather-data" class="nav-link" data-scroll-target="#weather-data">Weather data</a></li>
  <li><a href="#write-the-data-to-the-database" id="toc-write-the-data-to-the-database" class="nav-link" data-scroll-target="#write-the-data-to-the-database">Write the data to the database</a></li>
  </ul>
</li>
  <li>
<a href="#task-6---send-an-email-alert-if-something-is-fishy" id="toc-task-6---send-an-email-alert-if-something-is-fishy" class="nav-link" data-scroll-target="#task-6---send-an-email-alert-if-something-is-fishy">Task 6 - Send an email alert if something is fishy üêü</a>
  <ul class="collapse">
<li><a href="#define-conditionality" id="toc-define-conditionality" class="nav-link" data-scroll-target="#define-conditionality">Define conditionality</a></li>
  <li><a href="#compose-email" id="toc-compose-email" class="nav-link" data-scroll-target="#compose-email">Compose email</a></li>
  </ul>
</li>
  <li><a href="#task-7---add-logging-information-to-make-our-scheduled-report-informative" id="toc-task-7---add-logging-information-to-make-our-scheduled-report-informative" class="nav-link" data-scroll-target="#task-7---add-logging-information-to-make-our-scheduled-report-informative">Task 7 - Add logging information to make our scheduled report informative</a></li>
  <li><a href="#task-8---publish-and-schedule-on-posit-connect" id="toc-task-8---publish-and-schedule-on-posit-connect" class="nav-link" data-scroll-target="#task-8---publish-and-schedule-on-posit-connect">Task 8 - Publish and schedule on Posit Connect</a></li>
  </ul></nav>
</div>
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Raw Data Download</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><section id="goals" class="level2"><h2 class="anchored" data-anchor-id="goals">Goals</h2>
<p>The goals of this activity are to:</p>
<ul>
<li>Use <a href="https://httr2.r-lib.org">httr2</a> to download the raw Washington State Ferries data and weather data, which is used throughout this Workshop</li>
<li>Write the raw data to a database</li>
<li>Use a simple threshold alert to trigger a notification email</li>
<li>Publish this notebook to Posit Connect and put it on a rendering schedule so database updates happen automatically</li>
<li>See some general logging examples that make your scheduled reports more useful</li>
</ul>
<p>This will give you experience setting up a repeatable workflow for populating production data sources.</p>
</section><section id="data-sources" class="level2"><h2 class="anchored" data-anchor-id="data-sources">Data sources</h2>
<p>We are using data sets from two main sources, with the aim of gathering historical sailings, combining with historical weather, and developing a model to predict whether a future sailing will be delayed.</p>
<section id="from-wsdot-traveler-information-api" class="level3"><h3 class="anchored" data-anchor-id="from-wsdot-traveler-information-api">From WSDOT Traveler Information API</h3>
<p>(<a href="https://wsdot.wa.gov/traffic/api/" class="uri">https://wsdot.wa.gov/traffic/api/</a>)</p>
<table class="caption-top table">
<colgroup>
<col style="width: 20%">
<col style="width: 33%">
<col style="width: 45%">
</colgroup>
<thead><tr class="header">
<th>Endpoint</th>
<th>Description</th>
<th>API</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><strong>Vessel verbose</strong></td>
<td>Reference details about each ferry in the fleet, including name, model, and capacity</td>
<td><code>https://www.wsdot.wa.gov/ferries/api/vessels/ rest/vesselverbose?apiaccesscode={WSDOT_ACCESS_CODE}</code></td>
</tr>
<tr class="even">
<td><strong>Vessel history</strong></td>
<td>Historical sailings, including scheduled actual departure time</td>
<td><code>https://www.wsdot.wa.gov/ferries/api/vessels/ rest/vesselhistory/{VESSELNAME}/{DATESTART}/{DATEEND}?apiaccesscode={WSDOT_ACCESS_CODE}</code></td>
</tr>
<tr class="odd">
<td><strong>Terminal locations</strong></td>
<td>Terminal names and locations, including latitude and longitude, which we‚Äôll need for the weather data</td>
<td><code>https://www.wsdot.wa.gov/ferries/api/terminals/ rest/terminallocations?apiaccesscode={WSDOT_ACCESS_CODE}</code></td>
</tr>
</tbody>
</table></section><section id="from-open-meteo" class="level3"><h3 class="anchored" data-anchor-id="from-open-meteo">From Open Meteo</h3>
<p>(<a href="https://open-meteo.com/en/docs/historical-weather-api/">https://open-meteo.com/en/docs/</a>)</p>
<table class="caption-top table">
<colgroup>
<col style="width: 22%">
<col style="width: 45%">
<col style="width: 31%">
</colgroup>
<thead><tr class="header">
<th>Endpoint</th>
<th>Description</th>
<th>API</th>
</tr></thead>
<tbody><tr class="odd">
<td><strong>Historical weather</strong></td>
<td>Historical hourly weather at a specified latitude and longitude over a date range</td>
<td><code>https://archive-api.open-meteo.com/v1/ archive?{params}</code></td>
</tr></tbody>
</table>
<p>We will use the <a href="https://httr2.r-lib.org">httr2</a> package to download the data from these API sources.</p>
</section></section><section id="task-1---get-and-set-wsdot-environment-variable" class="level2"><h2 class="anchored" data-anchor-id="task-1---get-and-set-wsdot-environment-variable">Task 1 - Get and set WSDOT environment variable</h2>
<p>üîÑ Task</p>
<p>We are using an environment variable to access the WSDOT API called <strong><code>WSDOT_ACCESS_CODE</code></strong>. Visit <a href="https://wsdot.wa.gov/traffic/api/" class="uri">https://wsdot.wa.gov/traffic/api/</a> to get an API key for the use during this workshop.</p>
<p>To save this environment variable in your local development environment, add it to your <code>.Renviron</code> file. To do this, run the following command in your R console:</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">usethis</span><span class="fu">::</span><span class="fu"><a href="https://usethis.r-lib.org/reference/edit.html">edit_r_environ</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>.Renviron</strong></pre>
</div>
<div class="sourceCode" id="cb2" data-filename=".Renviron"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file: ~/.Renviron</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="va">WSDOT_ACCESS_CODE</span><span class="op">=</span>PASTE_VALUE_HERE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Don‚Äôt forget to restart your session to load your revised environment.</strong></p>
<p>üí° Remember, the <code>.Renviron</code> file does not get deployed with this content, and you should not commit it to git. It is a local file that sets environment variables for your R session. You will be able to set this variable in the ‚ÄúVars‚Äù pane on Connect when you deploy.</p>
<p>Now let‚Äôs set sail!</p>
</section><section id="load-packages" class="level2"><h2 class="anchored" data-anchor-id="load-packages">Load Packages</h2>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://httr2.r-lib.org">httr2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>‚îÄ‚îÄ Attaching core tidyverse packages ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ tidyverse 2.0.0 ‚îÄ‚îÄ
‚úî dplyr     1.1.4     ‚úî readr     2.1.5
‚úî forcats   1.0.0     ‚úî stringr   1.5.1
‚úî ggplot2   3.5.1     ‚úî tibble    3.2.1
‚úî lubridate 1.9.3     ‚úî tidyr     1.3.1
‚úî purrr     1.0.2     
‚îÄ‚îÄ Conflicts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ tidyverse_conflicts() ‚îÄ‚îÄ
‚úñ dplyr::filter() masks stats::filter()
‚úñ dplyr::lag()    masks stats::lag()
‚Ñπ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/sfirke/janitor">janitor</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'janitor'

The following objects are masked from 'package:stats':

    chisq.test, fisher.test</code></pre>
</div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dbi.r-dbi.org">DBI</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://odbc.r-dbi.org">odbc</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://glue.tidyverse.org/">glue</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://usethis.r-lib.org">usethis</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ryjohnson09/ferryfairy">ferryfairy</a></span><span class="op">)</span> <span class="co">#‚õ¥Ô∏è A custom package we wrote that is served by Package Manager</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="task-2---download-vessel-verbose-data" class="level2"><h2 class="anchored" data-anchor-id="task-2---download-vessel-verbose-data">Task 2 - Download vessel verbose data</h2>
<p>üîÑ Task</p>
<p>Get the following data set:</p>
<ul>
<li>
<strong>Vessel Verbose</strong>: the <code>https://www.wsdot.wa.gov/Ferries/API/Vessels/rest/vesselverbose</code> endpoint contains data about the ferries in the fleet.</li>
</ul>
<p>Use <a href="https://httr2.r-lib.org">httr2</a> to download the vessel verbose data set from the WSDOT API.</p>
<p>This API takes the form:</p>
<p><code>https://www.wsdot.wa.gov/ferries/api/vessels/rest/vesselverbose?apiaccesscode={WSDOT_ACCESS_CODE}</code></p>
<p>With <a href="https://httr2.r-lib.org">httr2</a> we compose the API request as <code>&lt;base url&gt;/&lt;path (aka endpoint)&gt;/&lt;query parameters&gt;</code></p>
<p>üí° Don‚Äôt split hairs over what part of your string is captured as the base URL versus the path. Do what makes you happy.</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">base_url</span> <span class="op">&lt;-</span> <span class="st">"https://www.wsdot.wa.gov"</span></span>
<span></span>
<span><span class="va">endpoint</span> <span class="op">&lt;-</span> <span class="st">"ferries/api/vessels/rest/vesselverbose"</span></span>
<span></span>
<span><span class="co"># Compose the API request </span></span>
<span><span class="va">req</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://httr2.r-lib.org/reference/request.html">request</a></span><span class="op">(</span><span class="va">base_url</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://httr2.r-lib.org/reference/req_url.html">req_url_path_append</a></span><span class="op">(</span><span class="va">endpoint</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://httr2.r-lib.org/reference/req_url.html">req_url_query</a></span><span class="op">(</span>apiaccesscode <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"WSDOT_ACCESS_CODE"</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># We can inspect the request before performing it</span></span>
<span><span class="va">req</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>&lt;httr2_request&gt;</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>GET
https://www.wsdot.wa.gov/ferries/api/vessels/rest/vesselverbose?apiaccesscode=dda1e83e-4c10-468a-ab37-c3671c5210d3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Body: empty</code></pre>
</div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># perform the request</span></span>
<span><span class="va">response</span> <span class="op">&lt;-</span> <span class="va">req</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://httr2.r-lib.org/reference/req_perform.html">req_perform</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">response</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>&lt;httr2_response&gt;</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>GET
https://www.wsdot.wa.gov/ferries/api/vessels/rest/vesselverbose?apiaccesscode=dda1e83e-4c10-468a-ab37-c3671c5210d3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Status: 200 OK</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Content-Type: application/json</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Body: In memory (38387 bytes)</code></pre>
</div>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># convert the body of the response to a tibble</span></span>
<span><span class="va">response_body</span> <span class="op">&lt;-</span> <span class="va">response</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://httr2.r-lib.org/reference/resp_body_raw.html">resp_body_string</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html">fromJSON</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">response_body</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 21 √ó 39
   VesselID VesselSubjectID VesselName VesselAbbrev Class$ClassID Status
      &lt;int&gt;           &lt;int&gt; &lt;chr&gt;      &lt;chr&gt;                &lt;int&gt;  &lt;int&gt;
 1        1               1 Cathlamet  CAT                     10      1
 2        2               2 Chelan     CHE                     10      1
 3       65             428 Chetzemoka CHZ                    162      1
 4       74             487 Chimacum   CHM                    100      1
 5       15              15 Issaquah   ISS                     10      1
 6       17              17 Kaleetan   KAL                     50      1
 7       52              52 Kennewick  KEN                    162      1
 8       18              18 Kitsap     KIS                     10      1
 9       19              19 Kittitas   KIT                     10      1
10       25              25 Puyallup   PUY                     90      1
# ‚Ñπ 11 more rows
# ‚Ñπ 39 more variables: Class$ClassSubjectID &lt;int&gt;, $ClassName &lt;chr&gt;,
#   $SortSeq &lt;int&gt;, $DrawingImg &lt;chr&gt;, $SilhouetteImg &lt;chr&gt;,
#   $PublicDisplayName &lt;chr&gt;, OwnedByWSF &lt;lgl&gt;, CarDeckRestroom &lt;lgl&gt;,
#   CarDeckShelter &lt;lgl&gt;, Elevator &lt;lgl&gt;, ADAAccessible &lt;lgl&gt;,
#   MainCabinGalley &lt;lgl&gt;, MainCabinRestroom &lt;lgl&gt;, PublicWifi &lt;lgl&gt;,
#   ADAInfo &lt;chr&gt;, AdditionalInfo &lt;chr&gt;, VesselNameDesc &lt;chr&gt;, ‚Ä¶</code></pre>
</div>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Sometimes special characters or spaces in column names are not</span></span>
<span><span class="co"># database-friendly, so we will use `janitor::clean_names` to</span></span>
<span><span class="co"># clean column names so there are no issues writing the data.</span></span>
<span><span class="co"># Additionally, the results include a nested dataframe of Class information - </span></span>
<span><span class="co"># we will unnest this so there are no errors with our database interpreting this.</span></span>
<span><span class="va">vesselinfo_raw</span> <span class="op">&lt;-</span> <span class="va">response_body</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html">unnest</a></span><span class="op">(</span><span class="va">Class</span><span class="op">)</span> <span class="op">|&gt;</span>  <span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> </span>
<span><span class="va">vesselinfo_raw</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 21 √ó 45
   vessel_id vessel_subject_id vessel_name vessel_abbrev class_id
       &lt;int&gt;             &lt;int&gt; &lt;chr&gt;       &lt;chr&gt;            &lt;int&gt;
 1         1                 1 Cathlamet   CAT                 10
 2         2                 2 Chelan      CHE                 10
 3        65               428 Chetzemoka  CHZ                162
 4        74               487 Chimacum    CHM                100
 5        15                15 Issaquah    ISS                 10
 6        17                17 Kaleetan    KAL                 50
 7        52                52 Kennewick   KEN                162
 8        18                18 Kitsap      KIS                 10
 9        19                19 Kittitas    KIT                 10
10        25                25 Puyallup    PUY                 90
# ‚Ñπ 11 more rows
# ‚Ñπ 40 more variables: class_subject_id &lt;int&gt;, class_name &lt;chr&gt;,
#   sort_seq &lt;int&gt;, drawing_img &lt;chr&gt;, silhouette_img &lt;chr&gt;,
#   public_display_name &lt;chr&gt;, status &lt;int&gt;, owned_by_wsf &lt;lgl&gt;,
#   car_deck_restroom &lt;lgl&gt;, car_deck_shelter &lt;lgl&gt;, elevator &lt;lgl&gt;,
#   ada_accessible &lt;lgl&gt;, main_cabin_galley &lt;lgl&gt;, main_cabin_restroom &lt;lgl&gt;,
#   public_wifi &lt;lgl&gt;, ada_info &lt;chr&gt;, additional_info &lt;chr&gt;, ‚Ä¶</code></pre>
</div>
</div>
</section><section id="task-3---connect-to-the-database" class="level2"><h2 class="anchored" data-anchor-id="task-3---connect-to-the-database">Task 3 - Connect to the database</h2>
<p>üîÑ Task</p>
<p>Create a database connection using the database connection details defined for you by your IT Admin (Workshop Instructors). Avoid hard-coding in any credentials. We‚Äôre using environment variables here.</p>
<p>We discussed that a database connection can be made using the generic <code>odbc</code> package, or a database-specific R package, such as <code>RPostgres</code>. The <code>RPostgres</code> package is DBI-compliant and is built specifically for PosgreSQL databases. Performance may be faster (particularly for writing data!) than using the generic <code>odbc</code> package, and there are more translations available, meaning more dplyr verbs will be available. <em>However,</em> because we are in a learning environment for this Workshop, we are choosing to use the <code>odbc</code> package so that we can see the database and it‚Äôs table appear in the RStudio Connections pane. This is a quality of life tradeoff, but if you‚Äôre doing intensive database work back in the real world, we recommend using a database-specific package, if available.</p>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Run this code as-is </span></span>
<span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html">dbConnect</a></span><span class="op">(</span></span>
<span>  <span class="fu">odbc</span><span class="fu">::</span><span class="fu"><a href="https://odbc.r-dbi.org/reference/dbConnect-OdbcDriver-method.html">odbc</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  Driver      <span class="op">=</span> <span class="st">"postgresql"</span>,</span>
<span>  Server      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"DATABASE_HOST"</span><span class="op">)</span>,</span>
<span>  Port        <span class="op">=</span> <span class="st">"5432"</span>,</span>
<span>  Database    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"DATABASE_NAME_R"</span><span class="op">)</span>,</span>
<span>  UID         <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"DATABASE_USER_R"</span><span class="op">)</span>,</span>
<span>  PWD         <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"DATABASE_PASSWORD_R"</span><span class="op">)</span>,</span>
<span>  timeout     <span class="op">=</span> <span class="fl">10</span></span>
<span><span class="op">)</span></span>
<span><span class="va">con</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://pins.rstudio.com/">pins</a></span><span class="op">)</span></span>
<span><span class="va">board</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://pins.rstudio.com/reference/board_connect.html">board_connect</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Connecting to Posit Connect 2024.08.0 at &lt;https://pub.current.posit.team&gt;</code></pre>
</div>
</div>
</section><section id="task-4---write-to-the-database" class="level2"><h2 class="anchored" data-anchor-id="task-4---write-to-the-database">Task 4 - Write to the database</h2>
<p>üîÑ Task</p>
<ul>
<li>Use <code>dbWriteTable</code> to write <code>vesselinfo_raw</code> into the database</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">my_username</span> <span class="op">&lt;-</span> <span class="st">"_____"</span> <span class="co">#Fill in your username, workshop participants!</span></span>
<span></span>
<span><span class="va">my_df_name</span> <span class="op">&lt;-</span> <span class="st">"vesselinfo_raw"</span></span>
<span></span>
<span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbWriteTable.html">dbWriteTable</a></span><span class="op">(</span>conn <span class="op">=</span> <span class="va">con</span>, <span class="co"># the connection</span></span>
<span>                  name <span class="op">=</span> <span class="va">my_df_name</span>, <span class="co"># the name of the table you will create in the DB</span></span>
<span>                  value <span class="op">=</span> <span class="va">vesselinfo_raw</span>,</span>
<span>                  overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">board</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://pins.rstudio.com/reference/pin_read.html">pin_write</a></span><span class="op">(</span><span class="va">vesselinfo_raw</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Using `name = 'vesselinfo_raw'`
Guessing `type = 'rds'`
! Use a fully specified name including user name: "katie.masiello@posit.co/vesselinfo_raw", not "vesselinfo_raw".

Writing to pin 'katie.masiello@posit.co/vesselinfo_raw'</code></pre>
</div>
</div>
</section><section id="task-5---get-and-write-the-other-data-sets" class="level2"><h2 class="anchored" data-anchor-id="task-5---get-and-write-the-other-data-sets">Task 5 - Get and write the other data sets</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>This task is similar to Tasks 3-4 from a Workshop perspective. We will speed through this code and pick up again on the next Task for new material.</p>
</div>
</div>
<p>Now we get the following additional data sets:</p>
<ul>
<li><p><strong>Vessel History</strong>: the <code>https://www.wsdot.wa.gov/Ferries/API/Vessels/rest/vesselhistory</code> endpoint contains historical data about sailings.</p></li>
<li><p><strong>Terminal locations</strong>: the <code>https://www.wsdot.wa.gov/Ferries/API/terminals/rest/terminallocations</code> endpoint contains information about ferry terminals locations.</p></li>
<li><p><strong>Weather data</strong>: the <code>https://archive-api.open-meteo.com/v1/archive?{params}</code> endpoint contains historical hourly weather information for a location and date, including things that may affect the timeliness of our ferry departure, such as wind speed, cloud cover, and precipitation.</p></li>
</ul>
<section id="vessel-history" class="level3"><h3 class="anchored" data-anchor-id="vessel-history">Vessel history</h3>
<p>We‚Äôll query 30 days looking back from today‚Äôs date, and use the vessel names we retrieved from the Vessel Verbose endpoint to query the <code>vesselhistory</code> endpoint for each vessel name.</p>
<p>Rather than manually repeating the API call for each vessel though, we‚Äôll use a function we wrote into the <code>ferryfairy</code> package that iterates the API call over the list of vessel names using the same technique as above with <code>httr2</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Specify our parameters:</span></span>
<span><span class="va">start_date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/now.html">today</a></span><span class="op">(</span><span class="op">)</span><span class="op">-</span><span class="fl">30</span></span>
<span><span class="va">end_date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/now.html">today</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">vesselnames</span> <span class="op">&lt;-</span> <span class="va">vesselinfo_raw</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">vessel_name</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Use `ferryfairy::get_vesselhistory` to iterate over all of the vessels. The results will be a list, with each vessel's history as a list item. </span></span>
<span><span class="va">data_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">vesselnames</span>, <span class="va">get_vesselhistory</span>, <span class="va">start_date</span>, <span class="va">end_date</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Getting vessel history for Cathlamet... 0 records retrieved for Cathlamet 
Getting vessel history for Chelan...    584 records retrieved for Chelan 
Getting vessel history for Chetzemoka...    905 records retrieved for Chetzemoka 
Getting vessel history for Chimacum...  628 records retrieved for Chimacum 
Getting vessel history for Issaquah...  640 records retrieved for Issaquah 
Getting vessel history for Kaleetan...  87 records retrieved for Kaleetan 
Getting vessel history for Kennewick... 607 records retrieved for Kennewick 
Getting vessel history for Kitsap...    1037 records retrieved for Kitsap 
Getting vessel history for Kittitas...  1158 records retrieved for Kittitas 
Getting vessel history for Puyallup...  756 records retrieved for Puyallup 
Getting vessel history for Salish...    257 records retrieved for Salish 
Getting vessel history for Samish...    422 records retrieved for Samish 
Getting vessel history for Sealth...    327 records retrieved for Sealth 
Getting vessel history for Spokane...   641 records retrieved for Spokane 
Getting vessel history for Suquamish... 1063 records retrieved for Suquamish 
Getting vessel history for Tacoma...    644 records retrieved for Tacoma 
Getting vessel history for Tillikum...  628 records retrieved for Tillikum 
Getting vessel history for Tokitae...   0 records retrieved for Tokitae 
Getting vessel history for Walla Walla...   0 records retrieved for Walla Walla 
Getting vessel history for Wenatchee... 0 records retrieved for Wenatchee 
Getting vessel history for Yakima...    552 records retrieved for Yakima </code></pre>
</div>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Convert the list into a data frame and clean the column names</span></span>
<span><span class="va">vesselhistory_raw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">data_list</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">vesselhistory_raw</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10,936 √ó 8
   vessel_id vessel departing arriving scheduled_depart           actual_depart 
       &lt;int&gt; &lt;chr&gt;  &lt;chr&gt;     &lt;chr&gt;    &lt;chr&gt;                      &lt;chr&gt;         
 1        27 Chelan Clinton   Mukilteo /Date(1721821200000-0700)/ /Date(1721821‚Ä¶
 2        27 Chelan Mukilteo  Clinton  /Date(1721822700000-0700)/ /Date(1721822‚Ä¶
 3        27 Chelan Clinton   Mukilteo /Date(1721824200000-0700)/ /Date(1721824‚Ä¶
 4        27 Chelan Mukilteo  Clinton  /Date(1721826000000-0700)/ /Date(1721826‚Ä¶
 5        27 Chelan Clinton   Mukilteo /Date(1721827800000-0700)/ /Date(1721827‚Ä¶
 6        27 Chelan Mukilteo  Clinton  /Date(1721829600000-0700)/ /Date(1721829‚Ä¶
 7        27 Chelan Clinton   Mukilteo /Date(1721831400000-0700)/ /Date(1721831‚Ä¶
 8        27 Chelan Mukilteo  Clinton  /Date(1721833200000-0700)/ /Date(1721833‚Ä¶
 9      8007 Chelan Clinton   Mukilteo /Date(1721836800000-0700)/ /Date(1721837‚Ä¶
10        27 Chelan Clinton   Mukilteo /Date(1721838600000-0700)/ /Date(1721839‚Ä¶
# ‚Ñπ 10,926 more rows
# ‚Ñπ 2 more variables: est_arrival &lt;chr&gt;, date &lt;chr&gt;</code></pre>
</div>
</div>
</section><section id="terminal-locations" class="level3"><h3 class="anchored" data-anchor-id="terminal-locations">Terminal locations</h3>
<p>Again, to simplify things, we use a function in <code>ferryfairy</code> to retrieve latitude and longitudes for each terminal. The function is a wrapper around <code>httr2</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">terminallocations</span> <span class="op">&lt;-</span> <span class="fu">ferryfairy</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ferryfairy/man/get_terminalinfo.html">get_terminalinfo</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">terminallocations</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 20 √ó 4
   terminal_id terminal_name       latitude longitude
         &lt;int&gt; &lt;chr&gt;                  &lt;dbl&gt;     &lt;dbl&gt;
 1           1 "Anacortes"             48.5     -123.
 2           3 "Bainbridge Island"     47.6     -123.
 3           4 "Bremerton"             47.6     -123.
 4           5 "Clinton"               48.0     -122.
 5          11 "Coupeville "           48.2     -123.
 6           8 "Edmonds"               47.8     -122.
 7           9 "Fauntleroy"            47.5     -122.
 8          10 "Friday Harbor"         48.5     -123.
 9          12 "Kingston"              47.8     -122.
10          13 "Lopez Island"          48.6     -123.
11          14 "Mukilteo"              48.0     -122.
12          15 "Orcas Island"          48.6     -123.
13          16 "Point Defiance"        47.3     -123.
14          17 "Port Townsend"         48.1     -123.
15           7 "Seattle"               47.6     -122.
16          18 "Shaw Island"           48.6     -123.
17          19 "Sidney B.C."           48.6     -123.
18          20 "Southworth"            47.5     -122.
19          21 "Tahlequah"             47.3     -123.
20          22 "Vashon Island"         47.5     -122.</code></pre>
</div>
</div>
</section><section id="weather-data" class="level3"><h3 class="anchored" data-anchor-id="weather-data">Weather data</h3>
<p>Similar to the approach used for retrieving Vessel History, we use a function in <code>ferryfairy</code> to call the weather API and iterate over all of the departing terminal locations.</p>
<p>The weather API allows us to specify the data and format we want in the query. We will include:</p>
<ul>
<li><p>precipitation (inches)</p></li>
<li><p>weather code</p></li>
<li><p>cloud cover at 10 m</p></li>
<li><p>wind speed at 10 m (as mph)</p></li>
<li><p>wind gusts at 10 m (as mph)</p></li>
<li><p>Timezone: US/Pacific</p></li>
</ul>
<p>The Open Meteo API is available to use without an API key when used for educational purposes according to their <a href="https://open-meteo.com/en/terms">Terms of Use</a>. As such, queries are limited to less than 10,000 API calls per day, 5,000 per hour and 600 per minute.</p>
<div class="cell">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Use `purrr::map` to iterate over all of the terminals. The results will be a list, with each terminal as a list item. </span></span>
<span><span class="va">data_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">terminallocations</span><span class="op">$</span><span class="va">terminal_name</span>, </span>
<span>                 <span class="fu">ferryfairy</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/ferryfairy/man/get_terminal_weather_history.html">get_terminal_weather_history</a></span>, </span>
<span>                 <span class="va">start_date</span>, <span class="va">end_date</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Getting weather history for Anacortes terminal...
    744 records retrieved for Anacortes
Getting weather history for Bainbridge Island terminal...
    744 records retrieved for Bainbridge Island
Getting weather history for Bremerton terminal...
    744 records retrieved for Bremerton
Getting weather history for Clinton terminal...
    744 records retrieved for Clinton
Getting weather history for Coupeville  terminal...
    744 records retrieved for Coupeville 
Getting weather history for Edmonds terminal...
    744 records retrieved for Edmonds
Getting weather history for Fauntleroy terminal...
    744 records retrieved for Fauntleroy
Getting weather history for Friday Harbor terminal...
    744 records retrieved for Friday Harbor
Getting weather history for Kingston terminal...
    744 records retrieved for Kingston
Getting weather history for Lopez Island terminal...
    744 records retrieved for Lopez Island
Getting weather history for Mukilteo terminal...
    744 records retrieved for Mukilteo
Getting weather history for Orcas Island terminal...
    744 records retrieved for Orcas Island
Getting weather history for Point Defiance terminal...
    744 records retrieved for Point Defiance
Getting weather history for Port Townsend terminal...
    744 records retrieved for Port Townsend
Getting weather history for Seattle terminal...
    744 records retrieved for Seattle
Getting weather history for Shaw Island terminal...
    744 records retrieved for Shaw Island
Getting weather history for Sidney B.C. terminal...
    744 records retrieved for Sidney B.C.
Getting weather history for Southworth terminal...
    744 records retrieved for Southworth
Getting weather history for Tahlequah terminal...
    744 records retrieved for Tahlequah
Getting weather history for Vashon Island terminal...
    744 records retrieved for Vashon Island</code></pre>
</div>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Convert the list into a data frame and clean the column names</span></span>
<span><span class="va">weather_terminal_history_raw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">data_list</span><span class="op">)</span> </span>
<span><span class="va">weather_terminal_history_raw</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 14,880 √ó 9
   terminal    lat  long time         precipitation weather_code cloud_cover_low
   &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;                &lt;dbl&gt;        &lt;int&gt;           &lt;int&gt;
 1 Anacortes  48.5 -123. 2024-07-24T‚Ä¶             0            0               0
 2 Anacortes  48.5 -123. 2024-07-24T‚Ä¶             0            0               0
 3 Anacortes  48.5 -123. 2024-07-24T‚Ä¶             0            0               0
 4 Anacortes  48.5 -123. 2024-07-24T‚Ä¶             0            0               0
 5 Anacortes  48.5 -123. 2024-07-24T‚Ä¶             0            0               0
 6 Anacortes  48.5 -123. 2024-07-24T‚Ä¶             0            0               0
 7 Anacortes  48.5 -123. 2024-07-24T‚Ä¶             0            0               0
 8 Anacortes  48.5 -123. 2024-07-24T‚Ä¶             0            0               0
 9 Anacortes  48.5 -123. 2024-07-24T‚Ä¶             0            0               9
10 Anacortes  48.5 -123. 2024-07-24T‚Ä¶             0            0               8
# ‚Ñπ 14,870 more rows
# ‚Ñπ 2 more variables: wind_speed_10m &lt;dbl&gt;, wind_gusts_10m &lt;dbl&gt;</code></pre>
</div>
</div>
</section><section id="write-the-data-to-the-database" class="level3"><h3 class="anchored" data-anchor-id="write-the-data-to-the-database">Write the data to the database</h3>
<p>We‚Äôll use a helper function from <a href="https://github.com/ryjohnson09/ferryfairy">ferryfairy</a> for brevity. This is a wrapper around <code>dbWriteTable</code> and uses the same method we used above in writing <code>vesselinfo</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/ferryfairy/man/write_df_to_db.html">write_df_to_db</a></span><span class="op">(</span><span class="va">vesselhistory_raw</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"vesselhistory_raw_"</span>,<span class="va">my_username</span><span class="op">)</span>, <span class="va">con</span>, append <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ferryfairy/man/write_df_to_db.html">write_df_to_db</a></span><span class="op">(</span><span class="va">terminallocations</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"terminallocations_"</span>,<span class="va">my_username</span><span class="op">)</span>, <span class="va">con</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ferryfairy/man/write_df_to_db.html">write_df_to_db</a></span><span class="op">(</span><span class="va">weather_terminal_history_raw</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"weather_terminal_history_raw_"</span>,<span class="va">my_username</span><span class="op">)</span>, <span class="va">con</span>, append <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># We're done here with the database, so we can close the connection</span></span>
<span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbDisconnect.html">dbDisconnect</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">board</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://pins.rstudio.com/reference/pin_read.html">pin_write</a></span><span class="op">(</span><span class="va">vesselhistory_raw</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Using `name = 'vesselhistory_raw'`
Guessing `type = 'rds'`
! Use a fully specified name including user name: "katie.masiello@posit.co/vesselhistory_raw", not "vesselhistory_raw".

Writing to pin 'katie.masiello@posit.co/vesselhistory_raw'</code></pre>
</div>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">board</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://pins.rstudio.com/reference/pin_read.html">pin_write</a></span><span class="op">(</span><span class="va">terminallocations</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Using `name = 'terminallocations'`
Guessing `type = 'rds'`
! Use a fully specified name including user name: "katie.masiello@posit.co/terminallocations", not "terminallocations".

Writing to pin 'katie.masiello@posit.co/terminallocations'</code></pre>
</div>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">board</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://pins.rstudio.com/reference/pin_read.html">pin_write</a></span><span class="op">(</span><span class="va">weather_terminal_history_raw</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Using `name = 'weather_terminal_history_raw'`
Guessing `type = 'rds'`
! Use a fully specified name including user name: "katie.masiello@posit.co/weather_terminal_history_raw", not "weather_terminal_history_raw".

Writing to pin 'katie.masiello@posit.co/weather_terminal_history_raw'</code></pre>
</div>
</div>
</section></section><section id="task-6---send-an-email-alert-if-something-is-fishy" class="level2"><h2 class="anchored" data-anchor-id="task-6---send-an-email-alert-if-something-is-fishy">Task 6 - Send an email alert if something is fishy üêü</h2>
<p>üîÑ Task</p>
<p>We will publish this document and schedule it to run daily. However, what if there‚Äôs something wrong with the data? We want to know about it!</p>
<p>Posit Connect has support for sending emails with Quarto: <a href="https://docs.posit.co/connect/user/quarto/#email-customization" class="uri">https://docs.posit.co/connect/user/quarto/#email-customization</a>.</p>
<p>The email subject and body are enclosed within <code>:::</code> divs and we specify that this document should render an email in the Quarto YAML block at the top of the document using <code>format: email</code>.</p>
<p>üí° Consider <code>format: email</code> as an extension of the more general <code>format: html</code>. This means other YAML options pertinent to html outputs like <code>toc</code> and <code>code-fold</code> can still be used.</p>
<ul>
<li>Assume that if fewer than 10 records are returned from any of the API calls, there‚Äôs an issue with the upstream data source and we want to receive an email alert about it.</li>
<li>Do this by setting <code>send_email</code> to <code>TRUE</code> within a block called <code>::: {email-scheduled}</code>. When the boolean is true, the email will be sent; otherwise, it will be suppressed. See <a href="https://docs.posit.co/connect/user/quarto/#suppressing-email" class="uri">https://docs.posit.co/connect/user/quarto/#suppressing-email</a>
</li>
</ul>
<section id="define-conditionality" class="level3"><h3 class="anchored" data-anchor-id="define-conditionality">Define conditionality</h3>
<div class="cell">
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">records_threshold</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">vesselinfo_raw</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">records_threshold</span> <span class="op">|</span> </span>
<span>   <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">vesselhistory_raw</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">records_threshold</span> <span class="op">|</span> </span>
<span>   <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">terminallocations</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">records_threshold</span> <span class="op">|</span> </span>
<span>   <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">weather_terminal_history_raw</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">records_threshold</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">send_email</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="va">send_email</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="compose-email" class="level3"><h3 class="anchored" data-anchor-id="compose-email">Compose email</h3>
<p>The email below will send if the alert condition is set.</p>
</section></section><section id="task-7---add-logging-information-to-make-our-scheduled-report-informative" class="level2"><h2 class="anchored" data-anchor-id="task-7---add-logging-information-to-make-our-scheduled-report-informative">Task 7 - Add logging information to make our scheduled report informative</h2>
<p>üîÑ Task</p>
<p>Make your scheduled reports work harder for you! Include information that you‚Äôll find useful to refer back to. Logging can be as basic or elaborate as you need.</p>
<p>Lets include:</p>
<ul>
<li><p>A nicely formatted time stamp.</p></li>
<li><p>A summary the main actions taken in the report, such as how many rows of data were downloaded, how many rows of data were written to the database</p></li>
</ul>
<p>Hint: The <code>glue</code> package is helpful for combining text and variables. It‚Äôs less work than stringing things together with <code>paste</code>. With <code><a href="https://glue.tidyverse.org/reference/glue.html">glue::glue()</a></code>, the syntax is <code>glue("Text with {&lt;r expression or variable&gt;}")</code></p>
<div class="cell">
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">stamp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>,tz<span class="op">=</span><span class="st">"US/Pacific"</span><span class="op">)</span>,<span class="st">'%A, %B %d, %Y %H:%M:%S'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"Report run {stamp}"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Report run Friday, August 23, 2024 07:39:22</code></pre>
</div>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"Wrote the following to the database: </span></span>
<span><span class="st">     </span></span>
<span><span class="st">     {nrow(vesselinfo_raw)} rows of raw vessel data</span></span>
<span><span class="st">     {nrow(vesselhistory_raw)} rows of raw vessel history</span></span>
<span><span class="st">     {nrow(terminallocations)} terminal location records</span></span>
<span><span class="st">     {nrow(weather_terminal_history_raw)} rows of weather data"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Wrote the following to the database: 

21 rows of raw vessel data
10936 rows of raw vessel history
20 terminal location records
14880 rows of weather data</code></pre>
</div>
</div>
</section><section id="task-8---publish-and-schedule-on-posit-connect" class="level2"><h2 class="anchored" data-anchor-id="task-8---publish-and-schedule-on-posit-connect">Task 8 - Publish and schedule on Posit Connect</h2>
<p>üîÑ Task</p>
<ul>
<li>Connect your account on Posit Connect to Workbench (Tools &gt; Global Options &gt; Publishing)</li>
<li>Use push-button publishing to publish this document, with source code, to Connect, but remember, _it is not good practice to bundle your <code>.Renviron</code> file with your deployment. Once the code is deployed to Connect, we will need to input our <code>WSDOT_API_KEY</code> in the Connect ‚ÄúVars‚Äù pane. Or we can publish the environment variable value directly using <code>rsconnect::deployApp(appFiles = c("01-raw-data-write.qmd", "mode_switch.png"), envVars = c("WSDOT_ACCESS_CODE"))</code>
</li>
<li>Schedule it to run on a timescale that seems appropriate for the data update cycle</li>
</ul>
<p>Note: Recall we specified our database connection details with environment variables. Typically when you publish content to Connect, you will also need to supply the environment variables using the ‚ÄúVars‚Äù pane in Connect. For this workshop, these environment variables have already been stored on the Connect server for you so you won‚Äôt need to do this step for this activity.</p>
<p>We‚Äôll do this task together as a group.</p>
<p>For reference, the Connect User Guide provides instructions for publishing: <a href="https://docs.posit.co/connect/user/publishing/#publishing-general" class="uri">https://docs.posit.co/connect/user/publishing/#publishing-general</a></p>
<!-- -->

</section></main><!-- /main column --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb50" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Raw Data Download"</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="co">  email:</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="co">    table-of-contents: true</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a><span class="co">    anchor-sections: true</span></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: false</span></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a><span class="co">    code-overflow: wrap</span></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a><span class="co">    code-summary: "Show Code"</span></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a><span class="co">    code-link: true</span></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a><span class="an">editor:</span><span class="co"> visual</span></span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a><span class="an">editor_options:</span><span class="co"> </span></span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a><span class="co">  chunk_output_type: console</span></span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a><span class="co">  canonical: true</span></span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a><span class="fu">## Goals</span></span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a>The goals of this activity are to:</span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Use <span class="in">`{httr2}`</span> to download the raw Washington State Ferries data and</span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a>    weather data, which is used throughout this Workshop</span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Write the raw data to a database</span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Use a simple threshold alert to trigger a notification email</span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Publish this notebook to Posit Connect and put it on a rendering</span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a>    schedule so database updates happen automatically</span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>See some general logging examples that make your scheduled reports</span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a>    more useful</span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-31"><a href="#cb50-31" aria-hidden="true" tabindex="-1"></a>This will give you experience setting up a repeatable workflow for</span>
<span id="cb50-32"><a href="#cb50-32" aria-hidden="true" tabindex="-1"></a>populating production data sources.</span>
<span id="cb50-33"><a href="#cb50-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-34"><a href="#cb50-34" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data sources</span></span>
<span id="cb50-35"><a href="#cb50-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-36"><a href="#cb50-36" aria-hidden="true" tabindex="-1"></a>We are using data sets from two main sources, with the aim of gathering</span>
<span id="cb50-37"><a href="#cb50-37" aria-hidden="true" tabindex="-1"></a>historical sailings, combining with historical weather, and developing a</span>
<span id="cb50-38"><a href="#cb50-38" aria-hidden="true" tabindex="-1"></a>model to predict whether a future sailing will be delayed.</span>
<span id="cb50-39"><a href="#cb50-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-40"><a href="#cb50-40" aria-hidden="true" tabindex="-1"></a><span class="fu">### From WSDOT Traveler Information API</span></span>
<span id="cb50-41"><a href="#cb50-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-42"><a href="#cb50-42" aria-hidden="true" tabindex="-1"></a>(<span class="ot">&lt;https://wsdot.wa.gov/traffic/api/&gt;</span>)</span>
<span id="cb50-43"><a href="#cb50-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-44"><a href="#cb50-44" aria-hidden="true" tabindex="-1"></a>| Endpoint               | Description                                                                                           | API                                                                                                                                     |</span>
<span id="cb50-45"><a href="#cb50-45" aria-hidden="true" tabindex="-1"></a>|---------------|------------------------|---------------------------------|</span>
<span id="cb50-46"><a href="#cb50-46" aria-hidden="true" tabindex="-1"></a>| **Vessel verbose**     | Reference details about each ferry in the fleet, including name, model, and capacity                  | <span class="in">`https://www.wsdot.wa.gov/ferries/api/vessels/ rest/vesselverbose?apiaccesscode={WSDOT_ACCESS_CODE}`</span>                                    |</span>
<span id="cb50-47"><a href="#cb50-47" aria-hidden="true" tabindex="-1"></a>| **Vessel history**     | Historical sailings, including scheduled actual departure time                                        | <span class="in">`https://www.wsdot.wa.gov/ferries/api/vessels/ rest/vesselhistory/{VESSELNAME}/{DATESTART}/{DATEEND}?apiaccesscode={WSDOT_ACCESS_CODE}`</span> |</span>
<span id="cb50-48"><a href="#cb50-48" aria-hidden="true" tabindex="-1"></a>| **Terminal locations** | Terminal names and locations, including latitude and longitude, which we'll need for the weather data | <span class="in">`https://www.wsdot.wa.gov/ferries/api/terminals/ rest/terminallocations?apiaccesscode={WSDOT_ACCESS_CODE}`</span>                              |</span>
<span id="cb50-49"><a href="#cb50-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-50"><a href="#cb50-50" aria-hidden="true" tabindex="-1"></a><span class="fu">### From Open Meteo</span></span>
<span id="cb50-51"><a href="#cb50-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-52"><a href="#cb50-52" aria-hidden="true" tabindex="-1"></a>(<span class="co">[</span><span class="ot">https://open-meteo.com/en/docs/</span><span class="co">](https://open-meteo.com/en/docs/historical-weather-api/)</span>)</span>
<span id="cb50-53"><a href="#cb50-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-54"><a href="#cb50-54" aria-hidden="true" tabindex="-1"></a>| Endpoint               | Description                                                                       | API                                                       |</span>
<span id="cb50-55"><a href="#cb50-55" aria-hidden="true" tabindex="-1"></a>|----------------|---------------------------------|-----------------------|</span>
<span id="cb50-56"><a href="#cb50-56" aria-hidden="true" tabindex="-1"></a>| **Historical weather** | Historical hourly weather at a specified latitude and longitude over a date range | <span class="in">`https://archive-api.open-meteo.com/v1/ archive?{params}`</span> |</span>
<span id="cb50-57"><a href="#cb50-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-58"><a href="#cb50-58" aria-hidden="true" tabindex="-1"></a>We will use the <span class="in">`{httr2}`</span> package to download the data from these API</span>
<span id="cb50-59"><a href="#cb50-59" aria-hidden="true" tabindex="-1"></a>sources.</span>
<span id="cb50-60"><a href="#cb50-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-61"><a href="#cb50-61" aria-hidden="true" tabindex="-1"></a><span class="fu">## Task 1 - Get and set WSDOT environment variable</span></span>
<span id="cb50-62"><a href="#cb50-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-63"><a href="#cb50-63" aria-hidden="true" tabindex="-1"></a>üîÑ Task</span>
<span id="cb50-64"><a href="#cb50-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-65"><a href="#cb50-65" aria-hidden="true" tabindex="-1"></a>We are using an environment variable to access the WSDOT API called</span>
<span id="cb50-66"><a href="#cb50-66" aria-hidden="true" tabindex="-1"></a>**`WSDOT_ACCESS_CODE`**. Visit <span class="ot">&lt;https://wsdot.wa.gov/traffic/api/&gt;</span> to</span>
<span id="cb50-67"><a href="#cb50-67" aria-hidden="true" tabindex="-1"></a>get an API key for the use during this workshop.</span>
<span id="cb50-68"><a href="#cb50-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-69"><a href="#cb50-69" aria-hidden="true" tabindex="-1"></a>To save this environment variable in your local development environment,</span>
<span id="cb50-70"><a href="#cb50-70" aria-hidden="true" tabindex="-1"></a>add it to your <span class="in">`.Renviron`</span> file. To do this, run the following command</span>
<span id="cb50-71"><a href="#cb50-71" aria-hidden="true" tabindex="-1"></a>in your R console:</span>
<span id="cb50-72"><a href="#cb50-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-75"><a href="#cb50-75" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb50-76"><a href="#cb50-76" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb50-77"><a href="#cb50-77" aria-hidden="true" tabindex="-1"></a>usethis<span class="sc">::</span><span class="fu">edit_r_environ</span>()</span>
<span id="cb50-78"><a href="#cb50-78" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-79"><a href="#cb50-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-80"><a href="#cb50-80" aria-hidden="true" tabindex="-1"></a><span class="in">``` {.bash filename=".Renviron"}</span></span>
<span id="cb50-81"><a href="#cb50-81" aria-hidden="true" tabindex="-1"></a><span class="in"># file: ~/.Renviron</span></span>
<span id="cb50-82"><a href="#cb50-82" aria-hidden="true" tabindex="-1"></a><span class="in">WSDOT_ACCESS_CODE=PASTE_VALUE_HERE</span></span>
<span id="cb50-83"><a href="#cb50-83" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-84"><a href="#cb50-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-85"><a href="#cb50-85" aria-hidden="true" tabindex="-1"></a>**Don't forget to restart your session to load your revised</span>
<span id="cb50-86"><a href="#cb50-86" aria-hidden="true" tabindex="-1"></a>environment.**</span>
<span id="cb50-87"><a href="#cb50-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-88"><a href="#cb50-88" aria-hidden="true" tabindex="-1"></a>üí° Remember, the <span class="in">`.Renviron`</span> file does not get deployed with this</span>
<span id="cb50-89"><a href="#cb50-89" aria-hidden="true" tabindex="-1"></a>content, and you should not commit it to git. It is a local file that</span>
<span id="cb50-90"><a href="#cb50-90" aria-hidden="true" tabindex="-1"></a>sets environment variables for your R session. You will be able to set</span>
<span id="cb50-91"><a href="#cb50-91" aria-hidden="true" tabindex="-1"></a>this variable in the "Vars" pane on Connect when you deploy.</span>
<span id="cb50-92"><a href="#cb50-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-93"><a href="#cb50-93" aria-hidden="true" tabindex="-1"></a>Now let's set sail!</span>
<span id="cb50-94"><a href="#cb50-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-95"><a href="#cb50-95" aria-hidden="true" tabindex="-1"></a><span class="fu">## Load Packages</span></span>
<span id="cb50-96"><a href="#cb50-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-99"><a href="#cb50-99" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb50-100"><a href="#cb50-100" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup</span></span>
<span id="cb50-101"><a href="#cb50-101" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb50-102"><a href="#cb50-102" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(httr2)</span>
<span id="cb50-103"><a href="#cb50-103" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb50-104"><a href="#cb50-104" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(janitor)</span>
<span id="cb50-105"><a href="#cb50-105" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DBI)</span>
<span id="cb50-106"><a href="#cb50-106" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(odbc)</span>
<span id="cb50-107"><a href="#cb50-107" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glue)</span>
<span id="cb50-108"><a href="#cb50-108" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(usethis)</span>
<span id="cb50-109"><a href="#cb50-109" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ferryfairy) <span class="co">#‚õ¥Ô∏è A custom package we wrote that is served by Package Manager</span></span>
<span id="cb50-110"><a href="#cb50-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-111"><a href="#cb50-111" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-112"><a href="#cb50-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-113"><a href="#cb50-113" aria-hidden="true" tabindex="-1"></a><span class="fu">## Task 2 - Download vessel verbose data</span></span>
<span id="cb50-114"><a href="#cb50-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-115"><a href="#cb50-115" aria-hidden="true" tabindex="-1"></a>üîÑ Task</span>
<span id="cb50-116"><a href="#cb50-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-117"><a href="#cb50-117" aria-hidden="true" tabindex="-1"></a>Get the following data set:</span>
<span id="cb50-118"><a href="#cb50-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-119"><a href="#cb50-119" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Vessel Verbose**: the</span>
<span id="cb50-120"><a href="#cb50-120" aria-hidden="true" tabindex="-1"></a>    <span class="in">`https://www.wsdot.wa.gov/Ferries/API/Vessels/rest/vesselverbose`</span></span>
<span id="cb50-121"><a href="#cb50-121" aria-hidden="true" tabindex="-1"></a>    endpoint contains data about the ferries in the fleet.</span>
<span id="cb50-122"><a href="#cb50-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-123"><a href="#cb50-123" aria-hidden="true" tabindex="-1"></a>Use <span class="in">`{httr2}`</span> to download the vessel verbose data set from the WSDOT</span>
<span id="cb50-124"><a href="#cb50-124" aria-hidden="true" tabindex="-1"></a>API.</span>
<span id="cb50-125"><a href="#cb50-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-126"><a href="#cb50-126" aria-hidden="true" tabindex="-1"></a>This API takes the form:</span>
<span id="cb50-127"><a href="#cb50-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-128"><a href="#cb50-128" aria-hidden="true" tabindex="-1"></a><span class="in">`https://www.wsdot.wa.gov/ferries/api/vessels/rest/vesselverbose?apiaccesscode={WSDOT_ACCESS_CODE}`</span></span>
<span id="cb50-129"><a href="#cb50-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-130"><a href="#cb50-130" aria-hidden="true" tabindex="-1"></a>With <span class="in">`{httr2}`</span> we compose the API request as</span>
<span id="cb50-131"><a href="#cb50-131" aria-hidden="true" tabindex="-1"></a><span class="in">`&lt;base url&gt;/&lt;path (aka endpoint)&gt;/&lt;query parameters&gt;`</span></span>
<span id="cb50-132"><a href="#cb50-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-133"><a href="#cb50-133" aria-hidden="true" tabindex="-1"></a>üí° Don't split hairs over what part of your string is captured as the</span>
<span id="cb50-134"><a href="#cb50-134" aria-hidden="true" tabindex="-1"></a>base URL versus the path. Do what makes you happy.</span>
<span id="cb50-135"><a href="#cb50-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-138"><a href="#cb50-138" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb50-139"><a href="#cb50-139" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: download raw vessel data</span></span>
<span id="cb50-140"><a href="#cb50-140" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb50-141"><a href="#cb50-141" aria-hidden="true" tabindex="-1"></a>base_url <span class="ot">&lt;-</span> <span class="st">"https://www.wsdot.wa.gov"</span></span>
<span id="cb50-142"><a href="#cb50-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-143"><a href="#cb50-143" aria-hidden="true" tabindex="-1"></a>endpoint <span class="ot">&lt;-</span> <span class="st">"ferries/api/vessels/rest/vesselverbose"</span></span>
<span id="cb50-144"><a href="#cb50-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-145"><a href="#cb50-145" aria-hidden="true" tabindex="-1"></a><span class="co"># Compose the API request </span></span>
<span id="cb50-146"><a href="#cb50-146" aria-hidden="true" tabindex="-1"></a>req <span class="ot">&lt;-</span> <span class="fu">request</span>(base_url) <span class="sc">|&gt;</span> </span>
<span id="cb50-147"><a href="#cb50-147" aria-hidden="true" tabindex="-1"></a>  <span class="fu">req_url_path_append</span>(endpoint) <span class="sc">|&gt;</span> </span>
<span id="cb50-148"><a href="#cb50-148" aria-hidden="true" tabindex="-1"></a>  <span class="fu">req_url_query</span>(<span class="at">apiaccesscode =</span> <span class="fu">Sys.getenv</span>(<span class="st">"WSDOT_ACCESS_CODE"</span>)) </span>
<span id="cb50-149"><a href="#cb50-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-150"><a href="#cb50-150" aria-hidden="true" tabindex="-1"></a><span class="co"># We can inspect the request before performing it</span></span>
<span id="cb50-151"><a href="#cb50-151" aria-hidden="true" tabindex="-1"></a>req</span>
<span id="cb50-152"><a href="#cb50-152" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb50-153"><a href="#cb50-153" aria-hidden="true" tabindex="-1"></a><span class="co"># perform the request</span></span>
<span id="cb50-154"><a href="#cb50-154" aria-hidden="true" tabindex="-1"></a>response <span class="ot">&lt;-</span> req <span class="sc">|&gt;</span> </span>
<span id="cb50-155"><a href="#cb50-155" aria-hidden="true" tabindex="-1"></a>  <span class="fu">req_perform</span>()</span>
<span id="cb50-156"><a href="#cb50-156" aria-hidden="true" tabindex="-1"></a>response</span>
<span id="cb50-157"><a href="#cb50-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-158"><a href="#cb50-158" aria-hidden="true" tabindex="-1"></a><span class="co"># convert the body of the response to a tibble</span></span>
<span id="cb50-159"><a href="#cb50-159" aria-hidden="true" tabindex="-1"></a>response_body <span class="ot">&lt;-</span> response <span class="sc">|&gt;</span> </span>
<span id="cb50-160"><a href="#cb50-160" aria-hidden="true" tabindex="-1"></a>  <span class="fu">resp_body_string</span>() <span class="sc">|&gt;</span> </span>
<span id="cb50-161"><a href="#cb50-161" aria-hidden="true" tabindex="-1"></a>  jsonlite<span class="sc">::</span><span class="fu">fromJSON</span>() <span class="sc">|&gt;</span> </span>
<span id="cb50-162"><a href="#cb50-162" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>()</span>
<span id="cb50-163"><a href="#cb50-163" aria-hidden="true" tabindex="-1"></a>response_body</span>
<span id="cb50-164"><a href="#cb50-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-165"><a href="#cb50-165" aria-hidden="true" tabindex="-1"></a><span class="co"># Sometimes special characters or spaces in column names are not</span></span>
<span id="cb50-166"><a href="#cb50-166" aria-hidden="true" tabindex="-1"></a><span class="co"># database-friendly, so we will use `janitor::clean_names` to</span></span>
<span id="cb50-167"><a href="#cb50-167" aria-hidden="true" tabindex="-1"></a><span class="co"># clean column names so there are no issues writing the data.</span></span>
<span id="cb50-168"><a href="#cb50-168" aria-hidden="true" tabindex="-1"></a><span class="co"># Additionally, the results include a nested dataframe of Class information - </span></span>
<span id="cb50-169"><a href="#cb50-169" aria-hidden="true" tabindex="-1"></a><span class="co"># we will unnest this so there are no errors with our database interpreting this.</span></span>
<span id="cb50-170"><a href="#cb50-170" aria-hidden="true" tabindex="-1"></a>vesselinfo_raw <span class="ot">&lt;-</span> response_body <span class="sc">|&gt;</span> <span class="fu">unnest</span>(Class) <span class="sc">|&gt;</span>  <span class="fu">clean_names</span>() </span>
<span id="cb50-171"><a href="#cb50-171" aria-hidden="true" tabindex="-1"></a>vesselinfo_raw</span>
<span id="cb50-172"><a href="#cb50-172" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-173"><a href="#cb50-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-174"><a href="#cb50-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-175"><a href="#cb50-175" aria-hidden="true" tabindex="-1"></a><span class="fu">## Task 3 - Connect to the database</span></span>
<span id="cb50-176"><a href="#cb50-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-177"><a href="#cb50-177" aria-hidden="true" tabindex="-1"></a>üîÑ Task</span>
<span id="cb50-178"><a href="#cb50-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-179"><a href="#cb50-179" aria-hidden="true" tabindex="-1"></a>Create a database connection using the database connection details</span>
<span id="cb50-180"><a href="#cb50-180" aria-hidden="true" tabindex="-1"></a>defined for you by your IT Admin (Workshop Instructors). Avoid</span>
<span id="cb50-181"><a href="#cb50-181" aria-hidden="true" tabindex="-1"></a>hard-coding in any credentials. We're using environment variables here.</span>
<span id="cb50-182"><a href="#cb50-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-183"><a href="#cb50-183" aria-hidden="true" tabindex="-1"></a>We discussed that a database connection can be made using the generic</span>
<span id="cb50-184"><a href="#cb50-184" aria-hidden="true" tabindex="-1"></a><span class="in">`odbc`</span> package, or a database-specific R package, such as <span class="in">`RPostgres`</span>.</span>
<span id="cb50-185"><a href="#cb50-185" aria-hidden="true" tabindex="-1"></a>The <span class="in">`RPostgres`</span> package is DBI-compliant and is built specifically for</span>
<span id="cb50-186"><a href="#cb50-186" aria-hidden="true" tabindex="-1"></a>PosgreSQL databases. Performance may be faster (particularly for writing</span>
<span id="cb50-187"><a href="#cb50-187" aria-hidden="true" tabindex="-1"></a>data!) than using the generic <span class="in">`odbc`</span> package, and there are more</span>
<span id="cb50-188"><a href="#cb50-188" aria-hidden="true" tabindex="-1"></a>translations available, meaning more dplyr verbs will be available.</span>
<span id="cb50-189"><a href="#cb50-189" aria-hidden="true" tabindex="-1"></a>*However,* because we are in a learning environment for this Workshop,</span>
<span id="cb50-190"><a href="#cb50-190" aria-hidden="true" tabindex="-1"></a>we are choosing to use the <span class="in">`odbc`</span> package so that we can see the</span>
<span id="cb50-191"><a href="#cb50-191" aria-hidden="true" tabindex="-1"></a>database and it's table appear in the RStudio Connections pane. This is</span>
<span id="cb50-192"><a href="#cb50-192" aria-hidden="true" tabindex="-1"></a>a quality of life tradeoff, but if you're doing intensive database work</span>
<span id="cb50-193"><a href="#cb50-193" aria-hidden="true" tabindex="-1"></a>back in the real world, we recommend using a database-specific package,</span>
<span id="cb50-194"><a href="#cb50-194" aria-hidden="true" tabindex="-1"></a>if available.</span>
<span id="cb50-195"><a href="#cb50-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-198"><a href="#cb50-198" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb50-199"><a href="#cb50-199" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: make database connection</span></span>
<span id="cb50-200"><a href="#cb50-200" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb50-201"><a href="#cb50-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-202"><a href="#cb50-202" aria-hidden="true" tabindex="-1"></a><span class="co"># Run this code as-is </span></span>
<span id="cb50-203"><a href="#cb50-203" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(</span>
<span id="cb50-204"><a href="#cb50-204" aria-hidden="true" tabindex="-1"></a>  odbc<span class="sc">::</span><span class="fu">odbc</span>(),</span>
<span id="cb50-205"><a href="#cb50-205" aria-hidden="true" tabindex="-1"></a>  <span class="at">Driver      =</span> <span class="st">"postgresql"</span>,</span>
<span id="cb50-206"><a href="#cb50-206" aria-hidden="true" tabindex="-1"></a>  <span class="at">Server      =</span> <span class="fu">Sys.getenv</span>(<span class="st">"DATABASE_HOST"</span>),</span>
<span id="cb50-207"><a href="#cb50-207" aria-hidden="true" tabindex="-1"></a>  <span class="at">Port        =</span> <span class="st">"5432"</span>,</span>
<span id="cb50-208"><a href="#cb50-208" aria-hidden="true" tabindex="-1"></a>  <span class="at">Database    =</span> <span class="fu">Sys.getenv</span>(<span class="st">"DATABASE_NAME_R"</span>),</span>
<span id="cb50-209"><a href="#cb50-209" aria-hidden="true" tabindex="-1"></a>  <span class="at">UID         =</span> <span class="fu">Sys.getenv</span>(<span class="st">"DATABASE_USER_R"</span>),</span>
<span id="cb50-210"><a href="#cb50-210" aria-hidden="true" tabindex="-1"></a>  <span class="at">PWD         =</span> <span class="fu">Sys.getenv</span>(<span class="st">"DATABASE_PASSWORD_R"</span>),</span>
<span id="cb50-211"><a href="#cb50-211" aria-hidden="true" tabindex="-1"></a>  <span class="at">timeout     =</span> <span class="dv">10</span></span>
<span id="cb50-212"><a href="#cb50-212" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-213"><a href="#cb50-213" aria-hidden="true" tabindex="-1"></a>con</span>
<span id="cb50-214"><a href="#cb50-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-215"><a href="#cb50-215" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-216"><a href="#cb50-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-219"><a href="#cb50-219" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb50-220"><a href="#cb50-220" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: alternate</span></span>
<span id="cb50-221"><a href="#cb50-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-222"><a href="#cb50-222" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pins)</span>
<span id="cb50-223"><a href="#cb50-223" aria-hidden="true" tabindex="-1"></a>board <span class="ot">&lt;-</span> <span class="fu">board_connect</span>()</span>
<span id="cb50-224"><a href="#cb50-224" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-225"><a href="#cb50-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-226"><a href="#cb50-226" aria-hidden="true" tabindex="-1"></a><span class="fu">## Task 4 - Write to the database</span></span>
<span id="cb50-227"><a href="#cb50-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-228"><a href="#cb50-228" aria-hidden="true" tabindex="-1"></a>üîÑ Task</span>
<span id="cb50-229"><a href="#cb50-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-230"><a href="#cb50-230" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Use <span class="in">`dbWriteTable`</span> to write <span class="in">`vesselinfo_raw`</span> into the database</span>
<span id="cb50-231"><a href="#cb50-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-234"><a href="#cb50-234" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb50-235"><a href="#cb50-235" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: database write</span></span>
<span id="cb50-236"><a href="#cb50-236" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb50-237"><a href="#cb50-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-238"><a href="#cb50-238" aria-hidden="true" tabindex="-1"></a>my_username <span class="ot">&lt;-</span> <span class="st">"_____"</span> <span class="co">#Fill in your username, workshop participants!</span></span>
<span id="cb50-239"><a href="#cb50-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-240"><a href="#cb50-240" aria-hidden="true" tabindex="-1"></a>my_df_name <span class="ot">&lt;-</span> <span class="st">"vesselinfo_raw"</span></span>
<span id="cb50-241"><a href="#cb50-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-242"><a href="#cb50-242" aria-hidden="true" tabindex="-1"></a>DBI<span class="sc">::</span><span class="fu">dbWriteTable</span>(<span class="at">conn =</span> con, <span class="co"># the connection</span></span>
<span id="cb50-243"><a href="#cb50-243" aria-hidden="true" tabindex="-1"></a>                  <span class="at">name =</span> my_df_name, <span class="co"># the name of the table you will create in the DB</span></span>
<span id="cb50-244"><a href="#cb50-244" aria-hidden="true" tabindex="-1"></a>                  <span class="at">value =</span> vesselinfo_raw,</span>
<span id="cb50-245"><a href="#cb50-245" aria-hidden="true" tabindex="-1"></a>                  <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb50-246"><a href="#cb50-246" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-247"><a href="#cb50-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-250"><a href="#cb50-250" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb50-251"><a href="#cb50-251" aria-hidden="true" tabindex="-1"></a>board <span class="sc">|&gt;</span> <span class="fu">pin_write</span>(vesselinfo_raw)</span>
<span id="cb50-252"><a href="#cb50-252" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-253"><a href="#cb50-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-254"><a href="#cb50-254" aria-hidden="true" tabindex="-1"></a><span class="fu">## Task 5 - Get and write the other data sets</span></span>
<span id="cb50-255"><a href="#cb50-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-256"><a href="#cb50-256" aria-hidden="true" tabindex="-1"></a>::: callout-note</span>
<span id="cb50-257"><a href="#cb50-257" aria-hidden="true" tabindex="-1"></a>This task is similar to Tasks 3-4 from a Workshop perspective. We will</span>
<span id="cb50-258"><a href="#cb50-258" aria-hidden="true" tabindex="-1"></a>speed through this code and pick up again on the next Task for new</span>
<span id="cb50-259"><a href="#cb50-259" aria-hidden="true" tabindex="-1"></a>material.</span>
<span id="cb50-260"><a href="#cb50-260" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb50-261"><a href="#cb50-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-262"><a href="#cb50-262" aria-hidden="true" tabindex="-1"></a>Now we get the following additional data sets:</span>
<span id="cb50-263"><a href="#cb50-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-264"><a href="#cb50-264" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Vessel History**: the</span>
<span id="cb50-265"><a href="#cb50-265" aria-hidden="true" tabindex="-1"></a>    <span class="in">`https://www.wsdot.wa.gov/Ferries/API/Vessels/rest/vesselhistory`</span></span>
<span id="cb50-266"><a href="#cb50-266" aria-hidden="true" tabindex="-1"></a>    endpoint contains historical data about sailings.</span>
<span id="cb50-267"><a href="#cb50-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-268"><a href="#cb50-268" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Terminal locations**: the</span>
<span id="cb50-269"><a href="#cb50-269" aria-hidden="true" tabindex="-1"></a>    <span class="in">`https://www.wsdot.wa.gov/Ferries/API/terminals/rest/terminallocations`</span></span>
<span id="cb50-270"><a href="#cb50-270" aria-hidden="true" tabindex="-1"></a>    endpoint contains information about ferry terminals locations.</span>
<span id="cb50-271"><a href="#cb50-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-272"><a href="#cb50-272" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Weather data**: the</span>
<span id="cb50-273"><a href="#cb50-273" aria-hidden="true" tabindex="-1"></a>    <span class="in">`https://archive-api.open-meteo.com/v1/archive?{params}`</span> endpoint</span>
<span id="cb50-274"><a href="#cb50-274" aria-hidden="true" tabindex="-1"></a>    contains historical hourly weather information for a location and</span>
<span id="cb50-275"><a href="#cb50-275" aria-hidden="true" tabindex="-1"></a>    date, including things that may affect the timeliness of our ferry</span>
<span id="cb50-276"><a href="#cb50-276" aria-hidden="true" tabindex="-1"></a>    departure, such as wind speed, cloud cover, and precipitation.</span>
<span id="cb50-277"><a href="#cb50-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-278"><a href="#cb50-278" aria-hidden="true" tabindex="-1"></a><span class="fu">### Vessel history</span></span>
<span id="cb50-279"><a href="#cb50-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-280"><a href="#cb50-280" aria-hidden="true" tabindex="-1"></a>We'll query 30 days looking back from today's date, and use the vessel</span>
<span id="cb50-281"><a href="#cb50-281" aria-hidden="true" tabindex="-1"></a>names we retrieved from the Vessel Verbose endpoint to query the</span>
<span id="cb50-282"><a href="#cb50-282" aria-hidden="true" tabindex="-1"></a><span class="in">`vesselhistory`</span> endpoint for each vessel name.</span>
<span id="cb50-283"><a href="#cb50-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-284"><a href="#cb50-284" aria-hidden="true" tabindex="-1"></a>Rather than manually repeating the API call for each vessel though,</span>
<span id="cb50-285"><a href="#cb50-285" aria-hidden="true" tabindex="-1"></a>we'll use a function we wrote into the <span class="in">`ferryfairy`</span> package that</span>
<span id="cb50-286"><a href="#cb50-286" aria-hidden="true" tabindex="-1"></a>iterates the API call over the list of vessel names using the same</span>
<span id="cb50-287"><a href="#cb50-287" aria-hidden="true" tabindex="-1"></a>technique as above with <span class="in">`httr2`</span>.</span>
<span id="cb50-288"><a href="#cb50-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-291"><a href="#cb50-291" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb50-292"><a href="#cb50-292" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: download raw vessel history</span></span>
<span id="cb50-293"><a href="#cb50-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-294"><a href="#cb50-294" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify our parameters:</span></span>
<span id="cb50-295"><a href="#cb50-295" aria-hidden="true" tabindex="-1"></a>start_date <span class="ot">&lt;-</span> <span class="fu">today</span>()<span class="sc">-</span><span class="dv">30</span></span>
<span id="cb50-296"><a href="#cb50-296" aria-hidden="true" tabindex="-1"></a>end_date <span class="ot">&lt;-</span> <span class="fu">today</span>()</span>
<span id="cb50-297"><a href="#cb50-297" aria-hidden="true" tabindex="-1"></a>vesselnames <span class="ot">&lt;-</span> vesselinfo_raw <span class="sc">|&gt;</span> <span class="fu">pull</span>(vessel_name)</span>
<span id="cb50-298"><a href="#cb50-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-299"><a href="#cb50-299" aria-hidden="true" tabindex="-1"></a><span class="co"># Use `ferryfairy::get_vesselhistory` to iterate over all of the vessels. The results will be a list, with each vessel's history as a list item. </span></span>
<span id="cb50-300"><a href="#cb50-300" aria-hidden="true" tabindex="-1"></a>data_list <span class="ot">&lt;-</span> <span class="fu">map</span>(vesselnames, get_vesselhistory, start_date, end_date)</span>
<span id="cb50-301"><a href="#cb50-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-302"><a href="#cb50-302" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the list into a data frame and clean the column names</span></span>
<span id="cb50-303"><a href="#cb50-303" aria-hidden="true" tabindex="-1"></a>vesselhistory_raw <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(data_list) <span class="sc">|&gt;</span> <span class="fu">clean_names</span>()</span>
<span id="cb50-304"><a href="#cb50-304" aria-hidden="true" tabindex="-1"></a>vesselhistory_raw</span>
<span id="cb50-305"><a href="#cb50-305" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-306"><a href="#cb50-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-307"><a href="#cb50-307" aria-hidden="true" tabindex="-1"></a><span class="fu">### Terminal locations</span></span>
<span id="cb50-308"><a href="#cb50-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-309"><a href="#cb50-309" aria-hidden="true" tabindex="-1"></a>Again, to simplify things, we use a function in <span class="in">`ferryfairy`</span> to retrieve</span>
<span id="cb50-310"><a href="#cb50-310" aria-hidden="true" tabindex="-1"></a>latitude and longitudes for each terminal. The function is a wrapper</span>
<span id="cb50-311"><a href="#cb50-311" aria-hidden="true" tabindex="-1"></a>around <span class="in">`httr2`</span>.</span>
<span id="cb50-312"><a href="#cb50-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-315"><a href="#cb50-315" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb50-316"><a href="#cb50-316" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: download terminal locations data</span></span>
<span id="cb50-317"><a href="#cb50-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-318"><a href="#cb50-318" aria-hidden="true" tabindex="-1"></a>terminallocations <span class="ot">&lt;-</span> ferryfairy<span class="sc">::</span><span class="fu">get_terminalinfo</span>()</span>
<span id="cb50-319"><a href="#cb50-319" aria-hidden="true" tabindex="-1"></a>terminallocations</span>
<span id="cb50-320"><a href="#cb50-320" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-321"><a href="#cb50-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-322"><a href="#cb50-322" aria-hidden="true" tabindex="-1"></a><span class="fu">### Weather data</span></span>
<span id="cb50-323"><a href="#cb50-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-324"><a href="#cb50-324" aria-hidden="true" tabindex="-1"></a>Similar to the approach used for retrieving Vessel History, we use a</span>
<span id="cb50-325"><a href="#cb50-325" aria-hidden="true" tabindex="-1"></a>function in <span class="in">`ferryfairy`</span> to call the weather API and iterate over all of</span>
<span id="cb50-326"><a href="#cb50-326" aria-hidden="true" tabindex="-1"></a>the departing terminal locations.</span>
<span id="cb50-327"><a href="#cb50-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-328"><a href="#cb50-328" aria-hidden="true" tabindex="-1"></a>The weather API allows us to specify the data and format we want in the</span>
<span id="cb50-329"><a href="#cb50-329" aria-hidden="true" tabindex="-1"></a>query. We will include:</span>
<span id="cb50-330"><a href="#cb50-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-331"><a href="#cb50-331" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>precipitation (inches)</span>
<span id="cb50-332"><a href="#cb50-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-333"><a href="#cb50-333" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>weather code</span>
<span id="cb50-334"><a href="#cb50-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-335"><a href="#cb50-335" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>cloud cover at 10 m</span>
<span id="cb50-336"><a href="#cb50-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-337"><a href="#cb50-337" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>wind speed at 10 m (as mph)</span>
<span id="cb50-338"><a href="#cb50-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-339"><a href="#cb50-339" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>wind gusts at 10 m (as mph)</span>
<span id="cb50-340"><a href="#cb50-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-341"><a href="#cb50-341" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Timezone: US/Pacific</span>
<span id="cb50-342"><a href="#cb50-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-343"><a href="#cb50-343" aria-hidden="true" tabindex="-1"></a>The Open Meteo API is available to use without an API key when used for</span>
<span id="cb50-344"><a href="#cb50-344" aria-hidden="true" tabindex="-1"></a>educational purposes according to their [Terms of</span>
<span id="cb50-345"><a href="#cb50-345" aria-hidden="true" tabindex="-1"></a>Use](https://open-meteo.com/en/terms). As such, queries are limited to</span>
<span id="cb50-346"><a href="#cb50-346" aria-hidden="true" tabindex="-1"></a>less than 10,000 API calls per day, 5,000 per hour and 600 per minute.</span>
<span id="cb50-347"><a href="#cb50-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-350"><a href="#cb50-350" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb50-351"><a href="#cb50-351" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: download weather data</span></span>
<span id="cb50-352"><a href="#cb50-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-353"><a href="#cb50-353" aria-hidden="true" tabindex="-1"></a><span class="co"># Use `purrr::map` to iterate over all of the terminals. The results will be a list, with each terminal as a list item. </span></span>
<span id="cb50-354"><a href="#cb50-354" aria-hidden="true" tabindex="-1"></a>data_list <span class="ot">&lt;-</span> <span class="fu">map</span>(terminallocations<span class="sc">$</span>terminal_name, </span>
<span id="cb50-355"><a href="#cb50-355" aria-hidden="true" tabindex="-1"></a>                 ferryfairy<span class="sc">::</span>get_terminal_weather_history, </span>
<span id="cb50-356"><a href="#cb50-356" aria-hidden="true" tabindex="-1"></a>                 start_date, end_date)</span>
<span id="cb50-357"><a href="#cb50-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-358"><a href="#cb50-358" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the list into a data frame and clean the column names</span></span>
<span id="cb50-359"><a href="#cb50-359" aria-hidden="true" tabindex="-1"></a>weather_terminal_history_raw <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(data_list) </span>
<span id="cb50-360"><a href="#cb50-360" aria-hidden="true" tabindex="-1"></a>weather_terminal_history_raw</span>
<span id="cb50-361"><a href="#cb50-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-362"><a href="#cb50-362" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-363"><a href="#cb50-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-364"><a href="#cb50-364" aria-hidden="true" tabindex="-1"></a><span class="fu">### Write the data to the database</span></span>
<span id="cb50-365"><a href="#cb50-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-366"><a href="#cb50-366" aria-hidden="true" tabindex="-1"></a>We'll use a helper function from <span class="in">`{ferryfairy}`</span> for brevity. This is a</span>
<span id="cb50-367"><a href="#cb50-367" aria-hidden="true" tabindex="-1"></a>wrapper around <span class="in">`dbWriteTable`</span> and uses the same method we used above in</span>
<span id="cb50-368"><a href="#cb50-368" aria-hidden="true" tabindex="-1"></a>writing <span class="in">`vesselinfo`</span>.</span>
<span id="cb50-369"><a href="#cb50-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-372"><a href="#cb50-372" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb50-373"><a href="#cb50-373" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: write remaining data to database</span></span>
<span id="cb50-374"><a href="#cb50-374" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb50-375"><a href="#cb50-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-376"><a href="#cb50-376" aria-hidden="true" tabindex="-1"></a><span class="fu">write_df_to_db</span>(vesselhistory_raw, <span class="fu">paste0</span>(<span class="st">"vesselhistory_raw_"</span>,my_username), con, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb50-377"><a href="#cb50-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-378"><a href="#cb50-378" aria-hidden="true" tabindex="-1"></a><span class="fu">write_df_to_db</span>(terminallocations, <span class="fu">paste0</span>(<span class="st">"terminallocations_"</span>,my_username), con, <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb50-379"><a href="#cb50-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-380"><a href="#cb50-380" aria-hidden="true" tabindex="-1"></a><span class="fu">write_df_to_db</span>(weather_terminal_history_raw, <span class="fu">paste0</span>(<span class="st">"weather_terminal_history_raw_"</span>,my_username), con, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb50-381"><a href="#cb50-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-382"><a href="#cb50-382" aria-hidden="true" tabindex="-1"></a><span class="co"># We're done here with the database, so we can close the connection</span></span>
<span id="cb50-383"><a href="#cb50-383" aria-hidden="true" tabindex="-1"></a><span class="fu">dbDisconnect</span>(con)</span>
<span id="cb50-384"><a href="#cb50-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-385"><a href="#cb50-385" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-386"><a href="#cb50-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-389"><a href="#cb50-389" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb50-390"><a href="#cb50-390" aria-hidden="true" tabindex="-1"></a>board <span class="sc">|&gt;</span> <span class="fu">pin_write</span>(vesselhistory_raw)</span>
<span id="cb50-391"><a href="#cb50-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-392"><a href="#cb50-392" aria-hidden="true" tabindex="-1"></a>board <span class="sc">|&gt;</span> <span class="fu">pin_write</span>(terminallocations)</span>
<span id="cb50-393"><a href="#cb50-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-394"><a href="#cb50-394" aria-hidden="true" tabindex="-1"></a>board <span class="sc">|&gt;</span> <span class="fu">pin_write</span>(weather_terminal_history_raw)</span>
<span id="cb50-395"><a href="#cb50-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-396"><a href="#cb50-396" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-397"><a href="#cb50-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-398"><a href="#cb50-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-399"><a href="#cb50-399" aria-hidden="true" tabindex="-1"></a><span class="fu">## Task 6 - Send an email alert if something is fishy üêü</span></span>
<span id="cb50-400"><a href="#cb50-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-401"><a href="#cb50-401" aria-hidden="true" tabindex="-1"></a>üîÑ Task</span>
<span id="cb50-402"><a href="#cb50-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-403"><a href="#cb50-403" aria-hidden="true" tabindex="-1"></a>We will publish this document and schedule it to run daily. However,</span>
<span id="cb50-404"><a href="#cb50-404" aria-hidden="true" tabindex="-1"></a>what if there's something wrong with the data? We want to know about it!</span>
<span id="cb50-405"><a href="#cb50-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-406"><a href="#cb50-406" aria-hidden="true" tabindex="-1"></a>Posit Connect has support for sending emails with Quarto:</span>
<span id="cb50-407"><a href="#cb50-407" aria-hidden="true" tabindex="-1"></a><span class="ot">&lt;https://docs.posit.co/connect/user/quarto/#email-customization&gt;</span>.</span>
<span id="cb50-408"><a href="#cb50-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-409"><a href="#cb50-409" aria-hidden="true" tabindex="-1"></a>The email subject and body are enclosed within <span class="in">`:::`</span> divs and we specify</span>
<span id="cb50-410"><a href="#cb50-410" aria-hidden="true" tabindex="-1"></a>that this document should render an email in the Quarto YAML block at</span>
<span id="cb50-411"><a href="#cb50-411" aria-hidden="true" tabindex="-1"></a>the top of the document using <span class="in">`format: email`</span>.</span>
<span id="cb50-412"><a href="#cb50-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-413"><a href="#cb50-413" aria-hidden="true" tabindex="-1"></a>üí° Consider <span class="in">`format: email`</span> as an extension of the more general</span>
<span id="cb50-414"><a href="#cb50-414" aria-hidden="true" tabindex="-1"></a><span class="in">`format: html`</span>. This means other YAML options pertinent to html outputs</span>
<span id="cb50-415"><a href="#cb50-415" aria-hidden="true" tabindex="-1"></a>like <span class="in">`toc`</span> and <span class="in">`code-fold`</span> can still be used.</span>
<span id="cb50-416"><a href="#cb50-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-417"><a href="#cb50-417" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Assume that if fewer than 10 records are returned from any of the</span>
<span id="cb50-418"><a href="#cb50-418" aria-hidden="true" tabindex="-1"></a>    API calls, there's an issue with the upstream data source and we</span>
<span id="cb50-419"><a href="#cb50-419" aria-hidden="true" tabindex="-1"></a>    want to receive an email alert about it.</span>
<span id="cb50-420"><a href="#cb50-420" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Do this by setting <span class="in">`send_email`</span> to <span class="in">`TRUE`</span> within a block called</span>
<span id="cb50-421"><a href="#cb50-421" aria-hidden="true" tabindex="-1"></a>    <span class="in">`::: {email-scheduled}`</span>. When the boolean is true, the email will be</span>
<span id="cb50-422"><a href="#cb50-422" aria-hidden="true" tabindex="-1"></a>    sent; otherwise, it will be suppressed. See</span>
<span id="cb50-423"><a href="#cb50-423" aria-hidden="true" tabindex="-1"></a>    <span class="ot">&lt;https://docs.posit.co/connect/user/quarto/#suppressing-email&gt;</span></span>
<span id="cb50-424"><a href="#cb50-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-425"><a href="#cb50-425" aria-hidden="true" tabindex="-1"></a><span class="fu">### Define conditionality</span></span>
<span id="cb50-426"><a href="#cb50-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-429"><a href="#cb50-429" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb50-430"><a href="#cb50-430" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: set conditions for sending email</span></span>
<span id="cb50-431"><a href="#cb50-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-432"><a href="#cb50-432" aria-hidden="true" tabindex="-1"></a>records_threshold <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb50-433"><a href="#cb50-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-434"><a href="#cb50-434" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">nrow</span>(vesselinfo_raw) <span class="sc">&lt;</span> records_threshold <span class="sc">|</span> </span>
<span id="cb50-435"><a href="#cb50-435" aria-hidden="true" tabindex="-1"></a>   <span class="fu">nrow</span>(vesselhistory_raw) <span class="sc">&lt;</span> records_threshold <span class="sc">|</span> </span>
<span id="cb50-436"><a href="#cb50-436" aria-hidden="true" tabindex="-1"></a>   <span class="fu">nrow</span>(terminallocations) <span class="sc">&lt;</span> records_threshold <span class="sc">|</span> </span>
<span id="cb50-437"><a href="#cb50-437" aria-hidden="true" tabindex="-1"></a>   <span class="fu">nrow</span>(weather_terminal_history_raw) <span class="sc">&lt;</span> records_threshold){</span>
<span id="cb50-438"><a href="#cb50-438" aria-hidden="true" tabindex="-1"></a>  send_email <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb50-439"><a href="#cb50-439" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> send_email <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb50-440"><a href="#cb50-440" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-441"><a href="#cb50-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-442"><a href="#cb50-442" aria-hidden="true" tabindex="-1"></a><span class="fu">### Compose email</span></span>
<span id="cb50-443"><a href="#cb50-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-444"><a href="#cb50-444" aria-hidden="true" tabindex="-1"></a>The email below will send if the alert condition is set.</span>
<span id="cb50-445"><a href="#cb50-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-446"><a href="#cb50-446" aria-hidden="true" tabindex="-1"></a>::: email</span>
<span id="cb50-447"><a href="#cb50-447" aria-hidden="true" tabindex="-1"></a>::: email-scheduled</span>
<span id="cb50-450"><a href="#cb50-450" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb50-451"><a href="#cb50-451" aria-hidden="true" tabindex="-1"></a>send_email</span>
<span id="cb50-452"><a href="#cb50-452" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-453"><a href="#cb50-453" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb50-454"><a href="#cb50-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-455"><a href="#cb50-455" aria-hidden="true" tabindex="-1"></a>::: subject</span>
<span id="cb50-456"><a href="#cb50-456" aria-hidden="true" tabindex="-1"></a>‚ö†Ô∏è Ferry Project: There was an issue with the raw data.</span>
<span id="cb50-457"><a href="#cb50-457" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb50-458"><a href="#cb50-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-459"><a href="#cb50-459" aria-hidden="true" tabindex="-1"></a>Fewer rows of raw data were retrieved than expected. The number of</span>
<span id="cb50-460"><a href="#cb50-460" aria-hidden="true" tabindex="-1"></a>records are:</span>
<span id="cb50-461"><a href="#cb50-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-464"><a href="#cb50-464" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb50-465"><a href="#cb50-465" aria-hidden="true" tabindex="-1"></a><span class="fu">glue</span>(<span class="st">"The following number of records were retrieved from the API sources: </span></span>
<span id="cb50-466"><a href="#cb50-466" aria-hidden="true" tabindex="-1"></a><span class="st">     </span></span>
<span id="cb50-467"><a href="#cb50-467" aria-hidden="true" tabindex="-1"></a><span class="st">     {nrow(vesselinfo_raw)} rows of raw vessel data</span></span>
<span id="cb50-468"><a href="#cb50-468" aria-hidden="true" tabindex="-1"></a><span class="st">     {nrow(vesselhistory_raw)} rows of raw vessel history</span></span>
<span id="cb50-469"><a href="#cb50-469" aria-hidden="true" tabindex="-1"></a><span class="st">     {nrow(terminallocations)} terminal location records</span></span>
<span id="cb50-470"><a href="#cb50-470" aria-hidden="true" tabindex="-1"></a><span class="st">     {nrow(weather_terminal_history_raw)} rows of weather data</span></span>
<span id="cb50-471"><a href="#cb50-471" aria-hidden="true" tabindex="-1"></a><span class="st">     </span></span>
<span id="cb50-472"><a href="#cb50-472" aria-hidden="true" tabindex="-1"></a><span class="st">     A minumum of {records_threshold} records are expected from each source. Please review the source data."</span>)</span>
<span id="cb50-473"><a href="#cb50-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-474"><a href="#cb50-474" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-475"><a href="#cb50-475" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb50-476"><a href="#cb50-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-477"><a href="#cb50-477" aria-hidden="true" tabindex="-1"></a><span class="fu">## Task 7 - Add logging information to make our scheduled report informative</span></span>
<span id="cb50-478"><a href="#cb50-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-479"><a href="#cb50-479" aria-hidden="true" tabindex="-1"></a>üîÑ Task</span>
<span id="cb50-480"><a href="#cb50-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-481"><a href="#cb50-481" aria-hidden="true" tabindex="-1"></a>Make your scheduled reports work harder for you! Include information</span>
<span id="cb50-482"><a href="#cb50-482" aria-hidden="true" tabindex="-1"></a>that you'll find useful to refer back to. Logging can be as basic or</span>
<span id="cb50-483"><a href="#cb50-483" aria-hidden="true" tabindex="-1"></a>elaborate as you need.</span>
<span id="cb50-484"><a href="#cb50-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-485"><a href="#cb50-485" aria-hidden="true" tabindex="-1"></a>Lets include:</span>
<span id="cb50-486"><a href="#cb50-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-487"><a href="#cb50-487" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>A nicely formatted time stamp.</span>
<span id="cb50-488"><a href="#cb50-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-489"><a href="#cb50-489" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>A summary the main actions taken in the report, such as how many</span>
<span id="cb50-490"><a href="#cb50-490" aria-hidden="true" tabindex="-1"></a>    rows of data were downloaded, how many rows of data were written to</span>
<span id="cb50-491"><a href="#cb50-491" aria-hidden="true" tabindex="-1"></a>    the database</span>
<span id="cb50-492"><a href="#cb50-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-493"><a href="#cb50-493" aria-hidden="true" tabindex="-1"></a>Hint: The <span class="in">`glue`</span> package is helpful for combining text and variables.</span>
<span id="cb50-494"><a href="#cb50-494" aria-hidden="true" tabindex="-1"></a>It's less work than stringing things together with <span class="in">`paste`</span>. With</span>
<span id="cb50-495"><a href="#cb50-495" aria-hidden="true" tabindex="-1"></a><span class="in">`glue::glue()`</span>, the syntax is</span>
<span id="cb50-496"><a href="#cb50-496" aria-hidden="true" tabindex="-1"></a><span class="in">`glue("Text with {&lt;r expression or variable&gt;}")`</span></span>
<span id="cb50-497"><a href="#cb50-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-500"><a href="#cb50-500" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb50-501"><a href="#cb50-501" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: logging</span></span>
<span id="cb50-502"><a href="#cb50-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-503"><a href="#cb50-503" aria-hidden="true" tabindex="-1"></a>stamp <span class="ot">&lt;-</span> <span class="fu">format</span>(<span class="fu">as.POSIXct</span>(<span class="fu">Sys.time</span>(),<span class="at">tz=</span><span class="st">"US/Pacific"</span>),<span class="st">'%A, %B %d, %Y %H:%M:%S'</span>)</span>
<span id="cb50-504"><a href="#cb50-504" aria-hidden="true" tabindex="-1"></a><span class="fu">glue</span>(<span class="st">"Report run {stamp}"</span>)</span>
<span id="cb50-505"><a href="#cb50-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-506"><a href="#cb50-506" aria-hidden="true" tabindex="-1"></a><span class="fu">glue</span>(<span class="st">"Wrote the following to the database: </span></span>
<span id="cb50-507"><a href="#cb50-507" aria-hidden="true" tabindex="-1"></a><span class="st">     </span></span>
<span id="cb50-508"><a href="#cb50-508" aria-hidden="true" tabindex="-1"></a><span class="st">     {nrow(vesselinfo_raw)} rows of raw vessel data</span></span>
<span id="cb50-509"><a href="#cb50-509" aria-hidden="true" tabindex="-1"></a><span class="st">     {nrow(vesselhistory_raw)} rows of raw vessel history</span></span>
<span id="cb50-510"><a href="#cb50-510" aria-hidden="true" tabindex="-1"></a><span class="st">     {nrow(terminallocations)} terminal location records</span></span>
<span id="cb50-511"><a href="#cb50-511" aria-hidden="true" tabindex="-1"></a><span class="st">     {nrow(weather_terminal_history_raw)} rows of weather data"</span>)</span>
<span id="cb50-512"><a href="#cb50-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-513"><a href="#cb50-513" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-514"><a href="#cb50-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-515"><a href="#cb50-515" aria-hidden="true" tabindex="-1"></a><span class="fu">## Task 8 - Publish and schedule on Posit Connect</span></span>
<span id="cb50-516"><a href="#cb50-516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-517"><a href="#cb50-517" aria-hidden="true" tabindex="-1"></a>üîÑ Task</span>
<span id="cb50-518"><a href="#cb50-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-519"><a href="#cb50-519" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Connect your account on Posit Connect to Workbench (Tools <span class="sc">\&gt;</span> Global</span>
<span id="cb50-520"><a href="#cb50-520" aria-hidden="true" tabindex="-1"></a>    Options <span class="sc">\&gt;</span> Publishing)</span>
<span id="cb50-521"><a href="#cb50-521" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Use push-button publishing to publish this document, with source</span>
<span id="cb50-522"><a href="#cb50-522" aria-hidden="true" tabindex="-1"></a>    code, to Connect, but remember, <span class="sc">\_</span>it is not good practice to bundle</span>
<span id="cb50-523"><a href="#cb50-523" aria-hidden="true" tabindex="-1"></a>    your <span class="in">`.Renviron`</span> file with your deployment. Once the code is</span>
<span id="cb50-524"><a href="#cb50-524" aria-hidden="true" tabindex="-1"></a>    deployed to Connect, we will need to input our <span class="in">`WSDOT_API_KEY`</span> in</span>
<span id="cb50-525"><a href="#cb50-525" aria-hidden="true" tabindex="-1"></a>    the Connect "Vars" pane. Or we can publish the environment variable</span>
<span id="cb50-526"><a href="#cb50-526" aria-hidden="true" tabindex="-1"></a>    value directly using</span>
<span id="cb50-527"><a href="#cb50-527" aria-hidden="true" tabindex="-1"></a>    <span class="in">`rsconnect::deployApp(appFiles = c("01-raw-data-write.qmd", "mode_switch.png"), envVars = c("WSDOT_ACCESS_CODE"))`</span></span>
<span id="cb50-528"><a href="#cb50-528" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Schedule it to run on a timescale that seems appropriate for the</span>
<span id="cb50-529"><a href="#cb50-529" aria-hidden="true" tabindex="-1"></a>    data update cycle</span>
<span id="cb50-530"><a href="#cb50-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-531"><a href="#cb50-531" aria-hidden="true" tabindex="-1"></a>Note: Recall we specified our database connection details with</span>
<span id="cb50-532"><a href="#cb50-532" aria-hidden="true" tabindex="-1"></a>environment variables. Typically when you publish content to Connect,</span>
<span id="cb50-533"><a href="#cb50-533" aria-hidden="true" tabindex="-1"></a>you will also need to supply the environment variables using the "Vars"</span>
<span id="cb50-534"><a href="#cb50-534" aria-hidden="true" tabindex="-1"></a>pane in Connect. For this workshop, these environment variables have</span>
<span id="cb50-535"><a href="#cb50-535" aria-hidden="true" tabindex="-1"></a>already been stored on the Connect server for you so you won't need to</span>
<span id="cb50-536"><a href="#cb50-536" aria-hidden="true" tabindex="-1"></a>do this step for this activity.</span>
<span id="cb50-537"><a href="#cb50-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-538"><a href="#cb50-538" aria-hidden="true" tabindex="-1"></a>We'll do this task together as a group.</span>
<span id="cb50-539"><a href="#cb50-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-540"><a href="#cb50-540" aria-hidden="true" tabindex="-1"></a>For reference, the Connect User Guide provides instructions for</span>
<span id="cb50-541"><a href="#cb50-541" aria-hidden="true" tabindex="-1"></a>publishing:</span>
<span id="cb50-542"><a href="#cb50-542" aria-hidden="true" tabindex="-1"></a><span class="ot">&lt;https://docs.posit.co/connect/user/publishing/#publishing-general&gt;</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>